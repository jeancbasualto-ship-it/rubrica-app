<script>
// Mock minimal de google.script.run para pruebas locales
(function(){
    if(typeof window === 'undefined') return;
    // Si el entorno ya provee google.script.run (Apps Script), no activar el mock
    if (window.google && window.google.script && window.google.script.run) return;
    window._mockDelay = 250;

    // Datos mock editables
    let sampleRubrics = {
        'rubric_1': {
            id: 'rubric_1',
            name: 'Rúbrica de ejemplo',
            description: 'Rúbrica generada de prueba',
            version: 1,
            origin: 'mock',
            modified: Date.now(),
            levels: [ {id:1,name:'Bajo',points:2}, {id:2,name:'Medio',points:5}, {id:3,name:'Alto',points:10} ],
            criteria: [ {name:'Claridad', max_points:10, level_descriptions:[{level_id:1,description:'Poco claro'},{level_id:2,description:'Claro'},{level_id:3,description:'Muy claro'}]}, {name:'Contenido', max_points:10, level_descriptions:[{level_id:1,description:'Escaso'},{level_id:2,description:'Adecuado'},{level_id:3,description:'Excelente'}]} ]
        },
        'rubric_2': {
            id: 'rubric_2',
            name: 'Rúbrica - Proyecto',
            description: 'Rúbrica orientada a proyectos',
            version: 1,
            origin: 'mock',
            modified: Date.now(),
            levels: [ {id:1,name:'Insuficiente',points:0}, {id:2,name:'Aceptable',points:6}, {id:3,name:'Excelente',points:12} ],
            criteria: [ {name:'Originalidad', max_points:12, level_descriptions:[{level_id:1,description:'Baja'},{level_id:2,description:'Buena'},{level_id:3,description:'Sobresaliente'}]}, {name:'Implementación', max_points:12, level_descriptions:[{level_id:1,description:'Incompleta'},{level_id:2,description:'Funcional'},{level_id:3,description:'Muy completa'}]} ]
        }
    };

    function buildRubricSummary(r){
        return {
            id: r.id,
            name: r.name,
            description: r.description,
            criteriaCount: (r.criteria && r.criteria.length) || 0,
            levelsCount: (r.levels && r.levels.length) || 0,
            modified: r.modified,
            version: r.version,
            origin: r.origin
        };
    }

    let sampleCourses = [
        {
            id: 'course_1',
            name: 'Matemáticas 1',
            students: [ {id:'s1',name:'Ana'}, {id:'s2',name:'Luis'}, {id:'s3',name:'María'} ],
            rubrics: { 'evaluacion_1': 'rubric_1' },
            grades: { 'evaluacion_1': { 's1': {0:2,1:3}, 's2': {0:1,1:2}, 's3': {0:3,1:4} } }
        },
        {
            id: 'course_2',
            name: 'Historia',
            students: [ {id:'s10',name:'Carlos'}, {id:'s11',name:'Lucía'} ],
            rubrics: { 'evaluacion_1': 'rubric_2' },
            grades: {}
        }
    ];

    function mockResponses(name, args){
        switch(name){
            case 'listSavedRubrics': return Object.keys(sampleRubrics).map(k=> buildRubricSummary(sampleRubrics[k]));
            case 'loadRubricById': {
                const id = args && args[0];
                return sampleRubrics[id] || null;
            }
            case 'duplicateRubric': return {success:true};
            case 'deleteRubricById': {
                const id = args && args[0];
                if(id && sampleRubrics[id]){ delete sampleRubrics[id]; return {success:true}; }
                return {success:false, message:'No existe'};
            }
            case 'saveRubricToDrive': {
                const r = args && args[0]; if(r && r.id) sampleRubrics[r.id] = r; return {success:true, id: r && r.id};
            }
            case 'generateRubric': return sampleRubrics['rubric_1'];
            case 'uploadAndAnalyzeRubricContent': return sampleRubrics['rubric_1'];
            case 'exportRubric': return 'Éxito: exportado (mock)';
            case 'saveEditedRubric': {
                const r = args && args[0]; if(r && r.id) sampleRubrics[r.id] = r; return {success:true};
            }
            case 'saveCourse': {
                const c = args && args[0]; if(c){ const existing = sampleCourses.find(x=>x.id===c.id); if(existing){ Object.assign(existing,c); } else { sampleCourses.push(c); } return {id: c.id || ('course_' + (sampleCourses.length + 1))}; }
                return {id:null};
            }
            case 'createCourse': return {id: 'course_' + (sampleCourses.length + 1)};
            case 'getCourseById': {
                const id = args && args[0];
                return sampleCourses.find(c=>c.id===id) || null;
            }
            case 'listCourses': return sampleCourses;
            case 'assignRubricToEvaluation': {
                const [courseId, evalKey, rubricId] = args || [];
                const c = sampleCourses.find(x=>x.id===courseId);
                if(c){ c.rubrics = c.rubrics || {}; c.rubrics[evalKey] = rubricId; return {success:true}; }
                return {success:false};
            }
            case 'loadStudents': {
                const id = args && args[0];
                const c = sampleCourses.find(x=>x.id===id);
                return c ? c.students : [];
            }
            case 'updateGrades': return {success:true};
            case 'loadCoursesFromSheets': return sampleCourses;
            case 'deleteCourse': {
                const id = args && args[0]; const idx = sampleCourses.findIndex(c=>c.id===id); if(idx>=0){ sampleCourses.splice(idx,1); return {success:true}; } return {success:false};
            }
            case 'createDocWithFeedback': return {url:'https://example.com/doc_mock', message:'Documento con feedback creado (mock)'};
            case 'createGradingDoc': return {url:'https://example.com\doc_mock', message:'Documento creado (mock)'};
            case 'createDocWithComments': return {url:'https://example.com/doc_comments_mock'};
            default:
                return {ok:true, name, args};
        }
    }

    // Implementación simple que soporta: withSuccessHandler(fn).withFailureHandler(fn).method(...args)
    window.google = window.google || {};
    window.google.script = window.google.script || {};

    window.google.script.run = (function(){
        let successFn = function(){}, failureFn = function(){};

        const builder = {
            withSuccessHandler(fn){ successFn = fn; return proxy; },
            withFailureHandler(fn){ failureFn = fn; return proxy; }
        };

        const proxy = new Proxy(builder, {
            get(target, prop){
                if(prop in target) return target[prop];
                // cualquier otro prop se interpreta como llamada al servidor
                return function(...args){
                    const name = prop;
                    try{
                        setTimeout(()=>{
                            const res = mockResponses(name, args);
                            // responder como JSON-string para mantener compatibilidad
                            successFn(typeof res === 'string' ? res : JSON.stringify(res));
                            // reset handlers
                            successFn = function(){}; failureFn = function(){};
                        }, window._mockDelay);
                    }catch(e){
                        setTimeout(()=> failureFn({message: e.message}), window._mockDelay);
                    }
                    return proxy;
                };
            }
        });

        return proxy;
    })();

    // Inicializar resumen primario (para panel)
    let sampleRubricSummary = buildRubricSummary(sampleRubrics[Object.keys(sampleRubrics)[0]] || { id:'', name:'', description:'', criteria:[], levels:[], modified: Date.now(), version:1, origin:'mock' });

    // Helper: update summary
    function refreshSummary(){
        const first = sampleRubrics[Object.keys(sampleRubrics)[0]];
        sampleRubricSummary = first ? buildRubricSummary(first) : null;
    }

    // Expose API to UI panel
    window.__mockApi = {
        getData(){ return { rubrics: sampleRubrics, rubricSummary: sampleRubricSummary, courses: sampleCourses, summaries: Object.keys(sampleRubrics).map(k=> buildRubricSummary(sampleRubrics[k])) }; },
            applyData: (d)=>{ if(d.rubrics) Object.assign(mockRubrics,d.rubrics); if(d.courses) sampleCourses = d.courses; updatePanelDisplay(); return true; },
            addCourse: (course)=>{
                course.id = 'c_' + Math.random().toString(36).slice(2,8);
                course.students = course.students || [];
                sampleCourses.unshift(course);
                updatePanelDisplay();
                return course;
            },
            addStudentToCourse: (courseId, student)=>{
                const c = sampleCourses.find(x=>x.id===courseId);
                if(!c) throw new Error('course not found');
                student.id = 's_' + Math.random().toString(36).slice(2,8);
                c.students.push(student);
                updatePanelDisplay();
                return student;
            },
            addRubric: (r)=>{
                const id = 'r_' + Math.random().toString(36).slice(2,8);
                mockRubrics[id] = r; sampleRubrics.unshift({ id, name: r.name, version: r.version || 1 });
                updatePanelDisplay();
                return id;
            },
            resetDefaults: ()=>{
                // no-op for now
                return true;
            }
        };

        // Wire up Mock Editor controls (if present)
        document.addEventListener('DOMContentLoaded', ()=>{
            const addCourseBtn = document.getElementById('mock-add-course');
            const addStudentBtn = document.getElementById('mock-add-student');
            if(addCourseBtn){
                addCourseBtn.addEventListener('click', ()=>{
                    const name = document.getElementById('mock-new-course-name').value.trim();
                    const studentsText = document.getElementById('mock-new-course-students').value.trim();
                    if(!name) return alert('Ingrese un nombre de curso');
                    const students = studentsText ? studentsText.split('\n').map(s=>({ name: s.trim() })).filter(Boolean) : [];
                    window.__mockApi.addCourse({ name, students });
                    document.getElementById('mock-new-course-name').value = '';
                    document.getElementById('mock-new-course-students').value = '';
                });
            }
            if(addStudentBtn){
                addStudentBtn.addEventListener('click', ()=>{
                    const select = document.getElementById('mock-course-select');
                    const studentName = document.getElementById('mock-new-student-name').value.trim();
                    if(!studentName) return alert('Ingrese nombre de estudiante');
                    if(!select || !select.value) return alert('Seleccione un curso');
                    window.__mockApi.addStudentToCourse(select.value, { name: studentName });
                    document.getElementById('mock-new-student-name').value = '';
                });
            }
        });

        addCourse(c){ const newId = c.id || ('course_' + (sampleCourses.length + 1)); c.id = newId; sampleCourses.push(c); return c; },
        addStudentToCourse(courseId, student){ const c = sampleCourses.find(x=>x.id===courseId); if(!c) return null; const sid = student.id || ('s' + (Math.floor(Math.random()*9000)+100)); student.id = sid; c.students.push(student); return student; },
        addRubric(r){ const id = r.id || ('rubric_' + (Object.keys(sampleRubrics).length + 1)); r.id = id; r.modified = Date.now(); sampleRubrics[id] = r; refreshSummary(); return r; },
        resetDefaults(){
            sampleRubrics = {
                'rubric_1': sampleRubrics['rubric_1'],
                'rubric_2': sampleRubrics['rubric_2']
            };
            sampleCourses = [
                { id: 'course_1', name: 'Matemáticas 1', students: [ {id:'s1',name:'Ana'}, {id:'s2',name:'Luis'}, {id:'s3',name:'María'} ], rubrics: { 'evaluacion_1': 'rubric_1' }, grades: { 'evaluacion_1': { 's1': {0:2,1:3}, 's2': {0:1,1:2}, 's3': {0:3,1:4} } } },
                { id: 'course_2', name: 'Historia', students: [ {id:'s10',name:'Carlos'}, {id:'s11',name:'Lucía'} ], rubrics: { 'evaluacion_1': 'rubric_2' }, grades: {} }
            ];
            refreshSummary();
        }
    };

    // Build a small debug panel in the page
    function buildMockPanel(){
        const panel = document.createElement('div');
        panel.id = 'mock-panel';
        panel.style.cssText = 'position:fixed;right:12px;bottom:12px;z-index:9999;width:320px;background:rgba(255,255,255,0.98);border:1px solid #e5e7eb;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-family:system-ui;font-size:13px;';

        panel.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <strong>Mock Editor</strong>
                <button id="mock-toggle-btn" title="Cerrar panel" style="border:none;background:#efefef;padding:4px 8px;border-radius:6px;cursor:pointer">✕</button>
            </div>
            <div style="margin-bottom:6px;"><small style="color:#6b7280">Rubrica:</small><div id="mock-rubric-name" style="font-weight:600;margin-top:2px"></div></div>
            <div style="margin-bottom:6px;"><small style="color:#6b7280">Buscar:</small><input id="mock-search" placeholder="Filtrar cursos/rúbricas" style="width:100%;margin-top:6px;padding:6px;border:1px solid #e5e7eb;border-radius:6px" /></div>
            <div style="margin-bottom:6px;"><small style="color:#6b7280">Cursos:</small><div id="mock-courses-list" style="margin-top:4px;max-height:120px;overflow:auto"></div></div>

            <div style="margin-bottom:8px;padding:8px;border:1px dashed #e5e7eb;border-radius:6px;background:#fafafa">
                <div style="font-weight:600;margin-bottom:6px">Nuevo curso</div>
                <input id="mock-new-course-name" placeholder="Nombre del curso" style="width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:6px" />
                <textarea id="mock-new-course-students" placeholder="Estudiantes (una por línea)" style="width:100%;height:68px;padding:6px;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:6px"></textarea>
                <div style="text-align:right"><button id="mock-add-course" style="background:#10b981;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Añadir curso</button></div>
            </div>

            <div style="margin-bottom:8px;padding:8px;border:1px dashed #e5e7eb;border-radius:6px;background:#fafafa">
                <div style="font-weight:600;margin-bottom:6px">Agregar estudiante a curso</div>
                <select id="mock-course-select" style="width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:6px"></select>
                <input id="mock-new-student-name" placeholder="Nombre del estudiante" style="width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:6px" />
                <div style="text-align:right"><button id="mock-add-student" style="background:#3b82f6;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Añadir estudiante</button></div>
            </div>

            <textarea id="mock-json" style="width:100%;height:120px;border:1px solid #e5e7eb;border-radius:6px;padding:6px;font-family:monospace;font-size:12px;">` + JSON.stringify({ rubrics: sampleRubrics, courses: sampleCourses }, null, 2) + `</textarea>
            <div style="display:flex;gap:6px;margin-top:8px;">
                <button id="mock-apply" style="flex:1;background:#4f46e5;color:white;border:none;padding:8px;border-radius:6px;cursor:pointer">Aplicar</button>
                <button id="mock-reset" style="flex:1;background:#e5e7eb;border:none;padding:8px;border-radius:6px;cursor:pointer">Reset</button>
            </div>
        `;

        document.body.appendChild(panel);

        document.getElementById('mock-toggle-btn').addEventListener('click', ()=> panel.remove());
        document.getElementById('mock-apply').addEventListener('click', ()=>{
            const txt = document.getElementById('mock-json').value;
            try{
                const parsed = JSON.parse(txt);
                window.__mockApi.applyData(parsed);
                updatePanelDisplay();
                alert('Mock aplicado');
            }catch(e){ alert('JSON inválido: '+e.message); }
        });
        document.getElementById('mock-reset').addEventListener('click', ()=>{ window.__mockApi.resetDefaults(); document.getElementById('mock-json').value = JSON.stringify(window.__mockApi.getData(), null, 2); updatePanelDisplay(); });
        // search/filter wiring
        const search = document.getElementById('mock-search');
        if(search){
            search.addEventListener('input', ()=> updatePanelDisplay(search.value));
        }

        // Add course button
        const addCourseBtn = document.getElementById('mock-add-course');
        if(addCourseBtn){
            addCourseBtn.addEventListener('click', ()=>{
                const name = (document.getElementById('mock-new-course-name')||{}).value || '';
                const studentsTxt = (document.getElementById('mock-new-course-students')||{}).value || '';
                const students = studentsTxt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map((n, i)=>({ id: 's' + (Date.now()%100000 + i), name: n }));
                if(!name){ alert('Ingresa un nombre de curso'); return; }
                if(window.__mockApi && typeof window.__mockApi.addCourse === 'function'){
                    const c = { name, students };
                    window.__mockApi.addCourse(c);
                    document.getElementById('mock-json').value = JSON.stringify(window.__mockApi.getData(), null, 2);
                    updatePanelDisplay();
                    alert('Curso añadido (mock)');
                }else{ alert('Mock API no disponible'); }
            });
        }

        // Add student button
        const addStudentBtn = document.getElementById('mock-add-student');
        if(addStudentBtn){
            addStudentBtn.addEventListener('click', ()=>{
                const courseId = (document.getElementById('mock-course-select')||{}).value;
                const studentName = (document.getElementById('mock-new-student-name')||{}).value || '';
                if(!courseId){ alert('Selecciona un curso'); return; }
                if(!studentName){ alert('Ingresa nombre de estudiante'); return; }
                if(window.__mockApi && typeof window.__mockApi.addStudentToCourse === 'function'){
                    const student = { name: studentName };
                    window.__mockApi.addStudentToCourse(courseId, student);
                    document.getElementById('mock-json').value = JSON.stringify(window.__mockApi.getData(), null, 2);
                    updatePanelDisplay();
                    alert('Estudiante añadido (mock)');
                }else{ alert('Mock API no disponible'); }
            });
        }
    }

    function updatePanelDisplay(){
        const data = window.__mockApi.getData();
        const nameEl = document.getElementById('mock-rubric-name');
        const coursesEl = document.getElementById('mock-courses-list');
        const selectEl = document.getElementById('mock-course-select');
        const firstRubric = data.summaries && data.summaries[0] ? data.summaries[0] : (Object.values(data.rubrics)[0] || null);
        if(nameEl) nameEl.textContent = firstRubric ? (firstRubric.name + ' (v' + (firstRubric.version||1) + ')') : '—';
        // accept optional filter
        const filter = (typeof arguments[0] === 'string') ? arguments[0].toLowerCase() : (document.getElementById('mock-search') && document.getElementById('mock-search').value.toLowerCase()) || '';
        if(coursesEl){
            const filtered = data.courses.filter(c=>{
                if(!filter) return true;
                if(c.name && c.name.toLowerCase().includes(filter)) return true;
                // check students
                if(c.students && c.students.some(s=> s.name && s.name.toLowerCase().includes(filter))) return true;
                // check rubrics assigned to course
                if(c.rubrics && Object.values(c.rubrics).some(rid=> (data.rubrics[rid] && data.rubrics[rid].name && data.rubrics[rid].name.toLowerCase().includes(filter)))) return true;
                return false;
            });
            coursesEl.innerHTML = filtered.map(c=>`<div style="padding:6px 0;border-bottom:1px dashed #f1f5f9;margin-bottom:6px"><strong>${c.name}</strong><div style="font-size:12px;color:#6b7280">${c.students.length} estudiantes</div></div>`).join('');
        }
        // populate course select for adding students
        if(selectEl){
            selectEl.innerHTML = '';
            data.courses.forEach(c=>{
                const opt = document.createElement('option'); opt.value = c.id; opt.text = c.name; selectEl.appendChild(opt);
            });
        }
    }

    // Initialize panel after DOM ready
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>{ buildMockPanel(); updatePanelDisplay(); });
    else { buildMockPanel(); updatePanelDisplay(); }

})();
</script>
